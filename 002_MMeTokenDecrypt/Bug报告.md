## 以下内容是我发送给苹果的Bug报告

* 日期：2016年10月17日

**原文：**[BugReport](https://github.com/manwhoami/MMeTokenDecrypt/blob/master/BugReport)

**翻译：**Chensh



----



**概要：**



敬启者，

目前要在每个版本的MacOS / OS X中实现程序自动插入某个记录，都缺乏一个关键的特性。

这个特性其实早已可以通过钥匙串访问程序来实现，但由于某些原因，迟迟没有开放给**“security”**命令行工具。

在**钥匙串访问程序**里面的**”访问控制“**中，选项**”询问钥匙串密码“**实现了这样的功能。

但它并不允许开发者使用程序来自动勾选这个选项，这种做法阻止了开发者安全地将数据信息存储到钥匙串中。

因为应用开发者并不能仅针对他们的应用或者合法的钥匙串所有者来限制钥匙串条目的访问。



例如，假设有人未经允许访问了我的电脑，然后想要获取到钥匙串里面Chrome安全存储条目中的键值，那么他所需要做的就是允许一个命令：**secutiry find-generic-password -ga 'Chrome'**.

而之后那些恶意用户所需要做的，仅仅是在弹出钥匙串弹窗点击**“允许”**按钮。

但是，如果本机主人以前曾经打开过钥匙串访问，在Chrome安全存储条目中的访问控制面板下，勾选过**“询问钥匙串密码”**的选项，那么就可以强制恶意用户必须输入钥匙串密码，否则未授权的访问将会被终止。

谷歌Chrome依旧可以无限制地访问这个钥匙串（这也是我们所希望的），因为它在访问控制面板下被列为了唯一授权应用。



此外，假如我们是远程攻击者，当“询问钥匙串密码”的选项没有被勾选，那么我们本质上就是通过代码实现强制弹窗提示，迫使用户单击“允许”按钮，这样我们就可以获得密码。

但是，如果“通过密码访问钥匙串”的选项被选中，并且用户点击了“拒绝”按钮，那么强制提示则会变得比较棘手。(参见参考文献)



**重现步骤：**

1. 谷歌Chrome浏览器是一个很好的例子，因为它是一个很常用的应用，而且可以非常直接查看到它通过MacOS系统或调用库创建的钥匙串条目。
2. 在我们勾选钥匙串访问面板中的“询问钥匙串密码”选项之前。我们先在命令行运行以下命令：**secutiry find-generic-password -ga 'Chrome'**，然后我们可以观察到，这些敏感信息非常需要钥匙串密码来验证以保证安全性。（这个安全存储键值可以解密谷歌chrome所有本地存储的密码）
3. 在钥匙串访问中，查找到“Chrome Safe Storage”条目，右键，显示简介，切换到访问控制面板，勾选“询问钥匙串密码”选项，然后保存更改。（这里钥匙串应用有个Bug，就是你需要重复这个操作两次才能够真正生效。但这个是无关本次议题的bug了）
4. 当我们使用命令**“security add-generic-password -T | -A”**来创建一个新的钥匙串密码条目后，打开谷歌Chrome浏览器，发现它并没有询问你确认你的密码，这是因为它已经是在受信任列表里面的应用了。
5. 在命令行下，我们再次运行**secutiry find-generic-password -ga 'Chrome'**这个命令，我们发现这次的弹窗需要你输入密码了。



**预期结果：**

经过这些步骤，你将了解到如何将密码设为必需。



**实际结果：**

如上所述。



**版本：**

所有的 MacOS 或 OSX 版本。



**注意：**

在MacOS中已经存在“询问钥匙串密码”的选项功能了。

实现这点只需要很少的资源。

我在此请求苹果开放程序控制这个功能给开发者（IE将新的条目参数添加到钥匙串的操作是：**‘security add-generic-password -T | -A’**），以便终止那些未经许可的钥匙串信息访问。

因此，希望把勾选“询问钥匙串密码”后的系统调用加入到“security”这个命令行工具的调用里面，提供一个参数允许开发者通过命令行工具去设置选项是否选中，而不是通过用户交互界面。

作为一个应用开发者，我不能指望我的用户通过操作GUI来保护我的应用里面的钥匙串条目。毕竟应用开发者的一个目标就是为了减少用户的繁琐操作。











